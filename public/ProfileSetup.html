<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Profile Setup</title>
    <link rel="stylesheet" href="css/styles.css" />
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="min-h-screen bg-slate-50 flex items-center justify-center p-4">
    <div
      class="w-full max-w-md mx-auto bg-white rounded-xl shadow-lg overflow-hidden"
    >
      <div class="bg-primary text-primary-foreground p-6 rounded-t-xl">
        <h1 class="text-center text-2xl font-bold">Profile Setup</h1>
      </div>
      <div class="p-6">
        <div class="w-full bg-background py-4">
          <div class="flex justify-between items-center mb-2">
            <div class="flex flex-col items-center">
              <div
                class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/80 text-primary-foreground"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-check"
                >
                  <path d="M20 6 9 17l-5-5" />
                </svg>
              </div>
              <span class="text-xs mt-1 text-muted-foreground">Phone</span>
            </div>
            <div class="flex flex-col items-center">
              <div
                class="flex items-center justify-center w-8 h-8 rounded-full bg-primary/80 text-primary-foreground"
              >
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="16"
                  height="16"
                  viewBox="0 0 24 24"
                  fill="none"
                  stroke="currentColor"
                  stroke-width="2"
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  class="lucide lucide-check"
                >
                  <path d="M20 6 9 17l-5-5" />
                </svg>
              </div>
              <span class="text-xs mt-1 text-muted-foreground">Register</span>
            </div>
            <div class="flex flex-col items-center">
              <div
                class="flex items-center justify-center w-8 h-8 rounded-full bg-primary text-primary-foreground"
              >
                3
              </div>
              <span class="text-xs mt-1 text-foreground font-medium"
                >Profile</span
              >
            </div>
          </div>
          <div
            class="relative w-full h-2 bg-muted rounded-full overflow-hidden"
          >
            <div
              class="absolute top-0 left-0 h-full bg-primary transition-all duration-300 ease-in-out"
              style="width: 66%"
            ></div>
          </div>
        </div>

        <form id="profileForm" class="mt-6 space-y-6">
          <!-- Avatar Upload -->
          <div class="w-full bg-white">
            <div class="p-6">
              <div class="flex flex-col items-center space-y-4">
                <h3 class="text-lg font-medium">Profile Picture</h3>
                <p class="text-sm text-muted-foreground text-center">
                  Upload a profile picture for your account.
                  <br />
                  JPG, PNG or GIF. Max size 5MB.
                </p>

                <div id="avatarPreviewContainer" class="relative hidden">
                  <img
                    id="avatarPreview"
                    src=""
                    alt="Avatar preview"
                    class="w-32 h-32 rounded-full object-cover border-2 border-primary/20"
                  />
                  <button
                    id="removeAvatar"
                    type="button"
                    class="absolute -top-2 -right-2 bg-destructive text-destructive-foreground rounded-full p-1 shadow-sm"
                    aria-label="Remove image"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path d="M18 6 6 18" />
                      <path d="m6 6 12 12" />
                    </svg>
                  </button>
                </div>

                <div
                  id="avatarDropzone"
                  class="w-full h-48 border-2 border-dashed rounded-lg flex flex-col items-center justify-center cursor-pointer transition-colors border-muted-foreground/20"
                >
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="40"
                    height="40"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    class="text-muted-foreground mb-2"
                  >
                    <rect width="18" height="18" x="3" y="3" rx="2" ry="2" />
                    <circle cx="9" cy="9" r="2" />
                    <path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21" />
                  </svg>
                  <p class="text-sm text-muted-foreground">
                    Drag and drop your image here
                  </p>
                  <p class="text-xs text-muted-foreground mt-1">or</p>
                  <button
                    type="button"
                    id="browseButton"
                    class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-secondary text-secondary-foreground shadow-sm hover:bg-secondary/80 h-8 rounded-md px-3 text-xs mt-2"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      width="16"
                      height="16"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-width="2"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                      class="mr-2"
                    >
                      <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                      <polyline points="17 8 12 3 7 8" />
                      <line x1="12" x2="12" y1="3" y2="15" />
                    </svg>
                    Browse Files
                  </button>
                </div>

                <input
                  type="file"
                  id="avatarInput"
                  accept="image/*"
                  class="hidden"
                  aria-label="Upload avatar"
                />
              </div>
            </div>
          </div>

          <div class="space-y-2">
            <label for="birthday" class="text-sm font-medium">Birthday</label>
            <input
              type="date"
              id="birthday"
              name="birthday"
              class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
              required
            />
            <p
              id="birthdayError"
              class="text-[0.8rem] font-medium text-destructive hidden"
            ></p>
          </div>

          <div class="space-y-2">
            <label for="city" class="text-sm font-medium">City</label>
            <input
              type="text"
              id="city"
              name="city"
              placeholder="Enter your city"
              class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
              required
            />
            <p
              id="cityError"
              class="text-[0.8rem] font-medium text-destructive hidden"
            ></p>
          </div>

          <div class="space-y-2">
            <label for="country" class="text-sm font-medium">Country</label>
            <input
              type="text"
              id="country"
              name="country"
              placeholder="Enter your country"
              class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
              required
            />
            <p
              id="countryError"
              class="text-[0.8rem] font-medium text-destructive hidden"
            ></p>
          </div>

          <div class="space-y-2">
            <label for="referenceNumber" class="text-sm font-medium"
              >Reference Number (Optional)</label
            >
            <input
              type="text"
              id="referenceNumber"
              name="referenceNumber"
              placeholder="Enter reference number"
              class="flex h-9 w-full rounded-md border border-input bg-transparent px-3 py-1 text-sm shadow-sm transition-colors placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring"
            />
          </div>

          <div class="flex justify-between">
            <button
              type="button"
              id="backButton"
              class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 border border-input bg-background shadow-sm hover:bg-accent hover:text-accent-foreground h-9 px-4 py-2"
            >
              Previous
            </button>
            <button
              type="submit"
              id="submitButton"
              class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50 bg-primary text-primary-foreground shadow hover:bg-primary/90 h-9 px-4 py-2"
            >
              Submit
            </button>
          </div>
        </form>
      </div>
    </div>

    <script type="module">
      import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.6/+esm";

      // Initialize Supabase client
      const supabaseUrl = "https://awrunspkmsvswrvphrdd.supabase.co";
      const supabaseKey =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF3cnVuc3BrbXN2c3dydnBocmRkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDQ3MjM1MDUsImV4cCI6MjA2MDI5OTUwNX0.dVSIE_ML-NYaTqn8RVkIXa-DvF6zXgJ9yHqy-XPq4Qc";
      const supabase = createClient(supabaseUrl, supabaseKey);

      // Check if we have data from previous steps
      const phone = localStorage.getItem("registration_phone");
      const firstName = localStorage.getItem("registration_firstName");
      const lastName = localStorage.getItem("registration_lastName");
      const email = localStorage.getItem("registration_email");

      if (!phone || !firstName || !lastName || !email) {
        // Redirect back if missing data
        window.location.href = "PhoneRegistration.html";
      }

      // Avatar upload handling
      let avatarFile = null;
      const avatarInput = document.getElementById("avatarInput");
      const avatarDropzone = document.getElementById("avatarDropzone");
      const avatarPreview = document.getElementById("avatarPreview");
      const avatarPreviewContainer = document.getElementById(
        "avatarPreviewContainer",
      );
      const removeAvatarButton = document.getElementById("removeAvatar");
      const browseButton = document.getElementById("browseButton");

      // Handle file selection
      avatarInput.addEventListener("change", handleFileSelect);

      // Handle drag and drop
      avatarDropzone.addEventListener("dragover", (e) => {
        e.preventDefault();
        avatarDropzone.classList.add("border-primary", "bg-primary/5");
        avatarDropzone.classList.remove("border-muted-foreground/20");
      });

      avatarDropzone.addEventListener("dragleave", (e) => {
        e.preventDefault();
        avatarDropzone.classList.remove("border-primary", "bg-primary/5");
        avatarDropzone.classList.add("border-muted-foreground/20");
      });

      avatarDropzone.addEventListener("drop", (e) => {
        e.preventDefault();
        avatarDropzone.classList.remove("border-primary", "bg-primary/5");
        avatarDropzone.classList.add("border-muted-foreground/20");

        if (e.dataTransfer.files && e.dataTransfer.files[0]) {
          processFile(e.dataTransfer.files[0]);
        }
      });

      // Handle click on dropzone
      avatarDropzone.addEventListener("click", () => {
        avatarInput.click();
      });

      // Handle click on browse button
      browseButton.addEventListener("click", (e) => {
        e.stopPropagation();
        avatarInput.click();
      });

      // Handle remove avatar button
      removeAvatarButton.addEventListener("click", () => {
        avatarFile = null;
        avatarInput.value = "";
        avatarPreviewContainer.classList.add("hidden");
        avatarDropzone.classList.remove("hidden");
      });

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          processFile(file);
        }
      }

      function processFile(file) {
        // Check if file is an image
        if (!file.type.startsWith("image/")) {
          alert("Please upload an image file");
          return;
        }

        // Check file size (max 5MB)
        if (file.size > 5 * 1024 * 1024) {
          alert("File size should be less than 5MB");
          return;
        }

        avatarFile = file;

        const reader = new FileReader();
        reader.onload = (e) => {
          avatarPreview.src = e.target.result;
          avatarPreviewContainer.classList.remove("hidden");
          avatarDropzone.classList.add("hidden");
        };
        reader.readAsDataURL(file);
      }

      // Handle back button
      document
        .getElementById("backButton")
        .addEventListener("click", function () {
          window.location.href = "Register.html";
        });

      // Handle form submission
      document
        .getElementById("profileForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault();

          const birthday = document.getElementById("birthday").value;
          const city = document.getElementById("city").value;
          const country = document.getElementById("country").value;
          const referenceNumber =
            document.getElementById("referenceNumber").value;

          // Basic validation
          let hasError = false;

          if (!birthday) {
            document.getElementById("birthdayError").textContent =
              "Please enter your birthday";
            document.getElementById("birthdayError").classList.remove("hidden");
            hasError = true;
          } else {
            document.getElementById("birthdayError").classList.add("hidden");
          }

          if (city.length < 2) {
            document.getElementById("cityError").textContent =
              "City must be at least 2 characters";
            document.getElementById("cityError").classList.remove("hidden");
            hasError = true;
          } else {
            document.getElementById("cityError").classList.add("hidden");
          }

          if (country.length < 2) {
            document.getElementById("countryError").textContent =
              "Country must be at least 2 characters";
            document.getElementById("countryError").classList.remove("hidden");
            hasError = true;
          } else {
            document.getElementById("countryError").classList.add("hidden");
          }

          if (hasError) return;

          // Disable submit button and show loading state
          const submitButton = document.getElementById("submitButton");
          submitButton.disabled = true;
          submitButton.textContent = "Submitting...";

          try {
            // Upload avatar if exists
            let avatarUrl = null;
            if (avatarFile) {
              const fileExt = avatarFile.name.split(".").pop();
              const fileName = `${Date.now()}.${fileExt}`;

              const { data: uploadData, error: uploadError } =
                await supabase.storage
                  .from("avatars")
                  .upload(fileName, avatarFile);

              if (uploadError) throw uploadError;

              avatarUrl = `${supabaseUrl}/storage/v1/object/public/avatars/${fileName}`;
            }

            // Insert user data into Supabase
            const { data, error } = await supabase.from("users").insert([
              {
                first_name: firstName,
                last_name: lastName,
                email: email,
                phone: phone,
                birthday: birthday,
                city: city,
                country: country,
                reference_number: referenceNumber,
                avatar_url: avatarUrl,
              },
            ]);

            if (error) throw error;

            // Clear localStorage
            localStorage.removeItem("registration_phone");
            localStorage.removeItem("registration_firstName");
            localStorage.removeItem("registration_lastName");
            localStorage.removeItem("registration_email");

            // Show success page
            window.location.href = "RegistrationSuccess.html";
          } catch (error) {
            console.error("Error:", error);
            alert(
              "Profile setup failed: " + (error.message || "Unknown error"),
            );
            submitButton.disabled = false;
            submitButton.textContent = "Submit";
          }
        });
    </script>
    <!-- Error handling script removed for production -->
  </body>
</html>
